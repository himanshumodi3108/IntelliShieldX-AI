/**
 * MalwareBazaar Service - Hash lookups and threat intelligence
 * According to API docs: Auth-Key is REQUIRED
 * Get your Auth-Key from: https://bazaar.abuse.ch/api/
 */
import axios from "axios";

class MalwareBazaarService {
  constructor() {
    this.apiKey = process.env.MALWAREBAZAAR_API_KEY;
    this.baseUrl = "https://mb-api.abuse.ch/api/v1";
  }

  /**
   * Get current API key (re-reads from environment to support updates)
   */
  getApiKey() {
    return process.env.MALWAREBAZAAR_API_KEY || this.apiKey;
  }

  /**
   * Check if service is enabled and configured
   * Re-reads API key from environment to support hot-reloading
   * According to API docs, Auth-Key is REQUIRED
   */
  isEnabled() {
    const apiKey = this.getApiKey();
    return !!apiKey && apiKey.trim() !== "";
  }

  /**
   * Query hash (MD5, SHA1, or SHA256)
   * According to API docs: POST to /api/v1/ with form data: query=get_info&hash=<hash>
   * @param {string} hash - File hash (MD5, SHA1, or SHA256)
   * @param {string} scanId - Optional scan ID for logging
   */
  async queryHash(hash, scanId = null) {
    const logPrefix = scanId ? `[Scan ID: ${scanId}]` : "[MalwareBazaar Service]";
    
    if (!this.isEnabled()) {
      throw new Error("MalwareBazaar API key (Auth-Key) not configured. Get one from https://bazaar.abuse.ch/api/");
    }

    try {
      // MalwareBazaar API: POST with form data
      // Format: query=get_info&hash=<hash>
      const formData = `query=get_info&hash=${encodeURIComponent(hash)}`;
      
      const response = await axios.post(
        `${this.baseUrl}/`, // Note: trailing slash
        formData,
        {
          headers: {
            "Auth-Key": this.getApiKey(), // API uses "Auth-Key" header (required)
            "Content-Type": "application/x-www-form-urlencoded",
            "Accept": "application/json",
          },
          timeout: 30000,
          validateStatus: (status) => status < 500, // Don't throw on 4xx errors
        }
      );

      // Handle error responses according to API docs
      if (response.status >= 400) {
        const queryStatus = response.data?.query_status;
        
        if (queryStatus === "no_api_key") {
          console.warn(`${logPrefix} MalwareBazaar API returned: no_api_key - Auth-Key missing`);
          return {
            scanned: false,
            found: false,
            error: "Authentication required - Auth-Key missing",
          };
        }
        
        if (queryStatus === "user_blacklisted") {
          console.error(`${logPrefix} MalwareBazaar API returned: user_blacklisted - API key is blacklisted`);
          return {
            scanned: false,
            found: false,
            error: "API key is blacklisted - please contact support",
          };
        }
        
        if (queryStatus === "http_post_expected") {
          console.error(`${logPrefix} MalwareBazaar API returned: http_post_expected - wrong HTTP method`);
          return {
            scanned: false,
            found: false,
            error: "API expects HTTP POST request",
          };
        }
        
        console.error(`${logPrefix} MalwareBazaar API returned error status ${response.status}:`, response.data);
        return {
          scanned: false,
          found: false,
          error: `API returned status ${response.status}: ${queryStatus || "Unknown error"}`,
        };
      }

      // Handle query status responses
      const queryStatus = response.data?.query_status;
      
      if (queryStatus === "hash_not_found") {
        console.log(`${logPrefix} Hash not found in MalwareBazaar database`);
        return {
          scanned: true,
          found: false,
          message: "Hash not found in MalwareBazaar database",
        };
      }

      if (queryStatus === "ok" && response.data.data) {
        // Data is an array of malware samples
        const dataArray = Array.isArray(response.data.data) 
          ? response.data.data 
          : [response.data.data];
        
        if (dataArray.length === 0) {
          return {
            scanned: true,
            found: false,
            message: "No malware samples found",
          };
        }

        // Use the first result (most relevant)
        const data = dataArray[0];

        // Determine malware family - use signature, or first tag, or "Unknown"
        const tags = Array.isArray(data.tags) ? data.tags : (data.tags ? [data.tags] : []);
        const malwareFamily = data.signature 
          ? data.signature 
          : (tags.length > 0 ? tags[0] : "Unknown");

        console.log(`${logPrefix} MalwareBazaar hash found - SHA256: ${data.sha256_hash}, Signature: ${data.signature || "N/A"}, Tags: ${tags.join(", ") || "none"}, File Type: ${data.file_type || "unknown"}`);

        // Construct permalink to view sample on MalwareBazaar
        const permalink = data.sha256_hash 
          ? `https://bazaar.abuse.ch/sample/${data.sha256_hash}/`
          : null;

        // Extract all available fields according to API response structure
        return {
          scanned: true,
          found: true,
          sha256: data.sha256_hash,
          sha1: data.sha1_hash,
          md5: data.md5_hash,
          fileName: data.file_name,
          fileSize: data.file_size,
          fileType: data.file_type,
          fileTypeMime: data.file_type_mime,
          malwareType: data.file_type, // Alias for backward compatibility
          malwareFamily: malwareFamily, // Use signature, or first tag, or "Unknown"
          signature: data.signature || null,
          reporter: data.reporter,
          anonymous: data.anonymous === 1,
          firstSeen: data.first_seen,
          lastSeen: data.last_seen,
          tags: tags, // Tags are already an array in API response
          imphash: data.imphash,
          tlsh: data.tlsh,
          ssdeep: data.ssdeep,
          magika: data.magika,
          intelligence: data.intelligence || {}, // Contains clamav, downloads, uploads, mail
          threatLevel: this.determineThreatLevel(data),
          permalink, // Link to view sample on MalwareBazaar
        };
      }

      return {
        scanned: true,
        found: false,
        message: "No data returned",
      };
    } catch (error) {
      if (axios.isAxiosError(error) && error.response) {
        const status = error.response.status;
        const statusText = error.response.statusText;
        const responseData = error.response.data;
        const queryStatus = responseData?.query_status;
        
        if (status === 401 || queryStatus === "no_api_key") {
          console.warn(`${logPrefix} MalwareBazaar API returned 401/no_api_key - Auth-Key may be missing or invalid`);
          return {
            scanned: false,
            found: false,
            error: "Authentication required - Auth-Key missing or invalid",
          };
        } else if (queryStatus === "user_blacklisted") {
          console.error(`${logPrefix} MalwareBazaar API returned: user_blacklisted - API key is blacklisted`);
          return {
            scanned: false,
            found: false,
            error: "API key is blacklisted - please contact support",
          };
        } else if (status === 429) {
          console.warn(`${logPrefix} MalwareBazaar API returned 429 Too Many Requests - rate limit exceeded`);
          return {
            scanned: false,
            found: false,
            error: "Rate limit exceeded",
            rateLimitExceeded: true,
          };
        } else if (status >= 500) {
          console.error(`${logPrefix} MalwareBazaar API server error: ${status} ${statusText}`, responseData);
        } else {
          console.error(`${logPrefix} MalwareBazaar API error: ${status} ${statusText}`, responseData);
        }
        
        return {
          scanned: false,
          found: false,
          error: `HTTP ${status}: ${statusText}${queryStatus ? ` - ${queryStatus}` : ""}`,
        };
      } else if (axios.isAxiosError(error) && error.request) {
        console.error(`${logPrefix} MalwareBazaar network error: No response received`, error.message);
        return {
          scanned: false,
          found: false,
          error: "Network error - service unreachable",
        };
      } else {
        console.error(`${logPrefix} MalwareBazaar query error:`, error.message);
        return {
          scanned: false,
          found: false,
          error: error.message,
        };
      }
    }
  }

  /**
   * Determine threat level from malware data
   */
  determineThreatLevel(data) {
    // Tags are an array in the API response
    const tags = Array.isArray(data.tags) 
      ? data.tags.map(t => String(t).toLowerCase()).join(" ")
      : (data.tags ? String(data.tags).toLowerCase() : "");
    const signature = (data.signature || "").toLowerCase();
    const fileType = (data.file_type || "").toLowerCase();

    // Critical threats - high-severity malware types
    if (
      tags.includes("trojan") || 
      tags.includes("ransomware") || 
      tags.includes("backdoor") ||
      tags.includes("rat") || // Remote Access Trojan
      tags.includes("stealer") ||
      signature.includes("ransomware") ||
      signature.includes("trojan") ||
      signature.includes("rat")
    ) {
      return "critical";
    }
    
    // High threats - general malware
    if (
      tags.includes("malware") || 
      tags.includes("virus") || 
      tags.includes("worm") ||
      tags.includes("botnet") ||
      signature.includes("malware") ||
      signature.includes("virus")
    ) {
      return "high";
    }
    
    // Medium threats - suspicious indicators
    if (
      tags.includes("suspicious") || 
      tags.includes("potentially") ||
      tags.includes("pup") || // Potentially Unwanted Program
      fileType === "elf" || // ELF files are often malware on Linux
      fileType === "exe" // Executables can be suspicious
    ) {
      return "medium";
    }
    
    // If signature exists but no specific threat indicators, still consider it a threat
    // (since it's in MalwareBazaar database, it's likely malicious)
    if (signature && signature !== "unknown" && signature.trim() !== "") {
      return "medium";
    }
    
    // If tags exist, it's at least a low-level threat
    if (tags && tags.trim() !== "") {
      return "low";
    }
    
    // If hash is in MalwareBazaar database but no indicators, still consider it suspicious
    return "low";
  }
}

export const malwareBazaarService = new MalwareBazaarService();

